# databases:
#   - name: dycetix-db
#     databaseName: dycetixdb
#     user: dycetix
#     region: oregon
#     plan: free

# services:
#   # Admin Application - UPDATED WITH AUTO-SETUP
#   - type: web
#     name: dycetix-admin
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
#       cd admin && python manage.py collectstatic --noinput
#     startCommand: |
#       cd admin
#       # Simple, clear migration order
#       python manage.py migrate accounts --noinput
#       python manage.py migrate --noinput
#       # Create superuser WITHOUT checking if exists
#       echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser(email='13238922wm@gmail.com', password='daxis@2006')" | python manage.py shell
#       gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: ADMIN_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'true'  # TEMPORARY: Set to true to see errors
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
    
#   # Customer Application - Add auto-migrations too
#   - type: web
#     name: dycetix-customer
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       cd customer && python manage.py collectstatic --noinput
#     startCommand: |
#       cd customer && 
#       python manage.py migrate --noinput &&
#       gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: CUSTOMER_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'false'
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
databases:
  - name: dycetix-db
    databaseName: dycetixdb
    user: dycetix
    region: oregon
    plan: free

services:
  # Admin Application - FIXED
  - type: web
    name: dycetix-admin
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
      cd admin && python manage.py collectstatic --noinput
    startCommand: |
        cd admin
        echo "=== Fixing migration dependencies ==="
        
        # Reset problematic migrations first
        python manage.py migrate --fake accounts zero
        python manage.py migrate --fake admin zero
        
        echo "=== Running migrations in correct order ==="
        python manage.py migrate accounts --noinput
        python manage.py migrate admin --noinput
        python manage.py migrate --noinput
        
        echo "=== Setting up superuser ==="
        python << 'EOF'
        import os
        import django
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
        django.setup()

        from django.contrib.auth import get_user_model
        User = get_user_model()

        admin_email = os.environ.get('ADMIN_EMAIL', '13238922wm@gmail.com')
        admin_password = os.environ.get('ADMIN_PASSWORD')

        print(f"Creating superuser with email: {admin_email}")

        try:
            if admin_email and admin_password:
                # Delete existing superuser if exists (clean slate)
                User.objects.filter(email=admin_email).delete()
                
                # Create new superuser
                user = User.objects.create_superuser(
                    email=admin_email,
                    password=admin_password
                )
                print(f"Superuser {admin_email} created successfully")
                print(f"User ID: {user.id}, Is Staff: {user.is_staff}, Is Superuser: {user.is_superuser}")
            else:
                print("ADMIN_EMAIL or ADMIN_PASSWORD not set")
        except Exception as e:
            print(f"Error creating superuser: {e}")
            import traceback
            traceback.print_exc()
        EOF
        
        echo "=== Starting server ==="
        gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: ADMIN_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0
      # ADD THESE - set in Render dashboard
      - key: ADMIN_EMAIL
        value: '13238922wm@gmail.com'
      - key: ADMIN_PASSWORD
        generateValue: true  # Render will generate a secure password
      - key: DJANGO_SETTINGS_MODULE
        value: 'config.settings'
    
  # Customer Application - STOP THIS FOR NOW
  # Comment out or remove until admin works
  # - type: web
  #   name: dycetix-customer
  #   ...
  # Customer Application - Add auto-migrations too
  - type: web
    name: dycetix-customer
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      cd customer && python manage.py collectstatic --noinput
    startCommand: |
      cd customer && 
      python manage.py migrate --noinput &&
      gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: CUSTOMER_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0