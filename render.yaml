# databases:
#   - name: dycetix-db
#     databaseName: dycetixdb
#     user: dycetix
#     region: oregon
#     plan: free

# services:
#   # Admin Application - UPDATED WITH AUTO-SETUP
#   - type: web
#     name: dycetix-admin
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
#       cd admin && python manage.py collectstatic --noinput
#     startCommand: |
#       cd admin
#       # Simple, clear migration order
#       python manage.py migrate accounts --noinput
#       python manage.py migrate --noinput
#       # Create superuser WITHOUT checking if exists
#       echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser(email='13238922wm@gmail.com', password='daxis@2006')" | python manage.py shell
#       gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: ADMIN_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'true'  # TEMPORARY: Set to true to see errors
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
    
#   # Customer Application - Add auto-migrations too
#   - type: web
#     name: dycetix-customer
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       cd customer && python manage.py collectstatic --noinput
#     startCommand: |
#       cd customer && 
#       python manage.py migrate --noinput &&
#       gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: CUSTOMER_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'false'
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
databases:
  - name: dycetix-db
    databaseName: dycetixdb
    user: dycetix
    region: oregon
    plan: free

services:
  # Admin Application - FIXED
  - type: web
    name: dycetix-admin
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
      cd admin && python manage.py collectstatic --noinput
    startCommand: |
      cd admin
      
      echo "=== NUCLEAR RESET - Fixing ALL migration issues ==="
      
      # First, let Django handle the migrations in correct order WITHOUT our intervention
      python << 'EOF'
      import os
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
      import django
      django.setup()

      from django.db import connection
      from django.core.management import call_command
      import sys

      print("1. Checking current migration state...")
      with connection.cursor() as cursor:
        cursor.execute("SELECT app, name, applied FROM django_migrations WHERE app IN ('accounts', 'admin') ORDER BY applied")
        migrations = cursor.fetchall()
        for m in migrations:
            print(f"  - {m[0]}.{m[1]} applied at {m[2]}")

      print("2. Fixing migration dependencies...")
      try:
        # First, ensure accounts migrations are marked as applied
        call_command('migrate', 'accounts', '--fake', interactive=False)
        
        # Then admin
        call_command('migrate', 'admin', '--fake', interactive=False)
        
        # Then everything else
        call_command('migrate', interactive=False)
        
        print("✅ Migrations fixed successfully")
      except Exception as e:
          print(f"❌ Error during migrations: {e}")
          # Fallback: drop and recreate
          print("Attempting fallback fix...")
          with connection.cursor() as cursor:
              cursor.execute("DELETE FROM django_migrations WHERE app IN ('accounts', 'admin')")
              print("Cleared accounts and admin migration history")
          
          # Re-run migrations
          call_command('migrate', interactive=False)
      EOF
      
      echo "=== Creating superuser ==="
      python << 'EOF'
      import os
      import django
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
      django.setup()

      from django.contrib.auth import get_user_model
      User = get_user_model()

      admin_email = os.environ.get('ADMIN_EMAIL', '13238922wm@gmail.com')
      admin_password = os.environ.get('ADMIN_PASSWORD')

      print(f"Creating superuser with email: {admin_email}")

      try:
          if admin_email and admin_password:
              # Check if user exists, update password if it does
              if User.objects.filter(email=admin_email).exists():
                  user = User.objects.get(email=admin_email)
                  user.set_password(admin_password)
                  user.is_staff = True
                  user.is_superuser = True
                  user.is_active = True
                  user.save()
                  print(f"Updated existing user {admin_email}")
              else:
                  user = User.objects.create_superuser(
                      email=admin_email,
                      password=admin_password
                  )
                  print(f"Created new superuser {admin_email}")
              
              print(f"   User ID: {user.id}, Is Staff: {user.is_staff}, Is Superuser: {user.is_superuser}")
          else:
              print("ADMIN_EMAIL or ADMIN_PASSWORD not set")
              print(f"   ADMIN_EMAIL: {admin_email}")
              print(f"   ADMIN_PASSWORD: {'Set' if admin_password else 'Not set'}")
      except Exception as e:
          print(f"Error creating superuser: {e}")
          import traceback
          traceback.print_exc()
      EOF
        
        echo "=== Starting server ==="
        gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: ADMIN_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0
      # ADD THESE - set in Render dashboard
      - key: ADMIN_EMAIL
        value: '13238922wm@gmail.com'
      - key: ADMIN_PASSWORD
        generateValue: true  # Render will generate a secure password
      - key: DJANGO_SETTINGS_MODULE
        value: 'config.settings'
    
  # Customer Application - STOP THIS FOR NOW
  # Comment out or remove until admin works
  # - type: web
  #   name: dycetix-customer
  #   ...
  # Customer Application - Add auto-migrations too
  - type: web
    name: dycetix-customer
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      cd customer && python manage.py collectstatic --noinput
    startCommand: |
      cd customer && 
      python manage.py migrate --noinput &&
      gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: CUSTOMER_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0