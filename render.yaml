# databases:
#   - name: dycetix-db
#     databaseName: dycetixdb
#     user: dycetix
#     region: oregon
#     plan: free

# services:
#   # Admin Application - UPDATED WITH AUTO-SETUP
#   - type: web
#     name: dycetix-admin
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
#       cd admin && python manage.py collectstatic --noinput
#     startCommand: |
#       cd admin
#       # Simple, clear migration order
#       python manage.py migrate accounts --noinput
#       python manage.py migrate --noinput
#       # Create superuser WITHOUT checking if exists
#       echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser(email='13238922wm@gmail.com', password='daxis@2006')" | python manage.py shell
#       gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: ADMIN_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'true'  # TEMPORARY: Set to true to see errors
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
    
#   # Customer Application - Add auto-migrations too
#   - type: web
#     name: dycetix-customer
#     env: python
#     region: oregon
#     plan: free
#     buildCommand: |
#       pip install --upgrade pip
#       pip install -r requirements.txt
#       cd customer && python manage.py collectstatic --noinput
#     startCommand: |
#       cd customer && 
#       python manage.py migrate --noinput &&
#       gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
#     envVars:
#       - key: DATABASE_URL
#         fromDatabase:
#           name: dycetix-db
#           property: connectionString
#       - key: CUSTOMER_SECRET_KEY
#         generateValue: true
#       - key: DEBUG
#         value: 'false'
#       - key: RENDER
#         value: 'true'
#       - key: PYTHON_VERSION
#         value: 3.11.0
databases:
  - name: dycetix-db
    databaseName: dycetixdb
    user: dycetix
    region: oregon
    plan: free

services:
  # Admin Application - FIXED
  - type: web
    name: dycetix-admin
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      export PYTHONPATH=/opt/render/project/src:$PYTHONPATH
      cd admin && python manage.py collectstatic --noinput
    startCommand: |
      cd admin
      # 1. Apply ALL migrations first
      echo "=== Running migrations ==="
      python manage.py migrate --noinput
      
      # 2. Check if superuser exists, create if not (SECURELY)
      echo "=== Setting up superuser ==="
      python << 'EOF'
      import os
      import django
      django.setup()
      from django.contrib.auth import get_user_model
      User = get_user_model()

      # Get credentials from environment variables
      admin_email = os.environ.get('ADMIN_EMAIL', 'admin@example.com')
      admin_password = os.environ.get('ADMIN_PASSWORD')

      if not User.objects.filter(email=admin_email).exists() and admin_password:
          User.objects.create_superuser(
              email=admin_email,
              password=admin_password
          )
          print(f"Superuser {admin_email} created")
      else:
          print("Superuser already exists or no password provided")
      EOF
      
      # 3. Start the server
      echo "=== Starting server ==="
      gunicorn config.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: ADMIN_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0
      # ADD THESE - set in Render dashboard
      - key: ADMIN_EMAIL
        value: '13238922wm@gmail.com'
      - key: ADMIN_PASSWORD
        generateValue: true  # Render will generate a secure password
      - key: DJANGO_SETTINGS_MODULE
        value: 'config.settings'
    
  # Customer Application - STOP THIS FOR NOW
  # Comment out or remove until admin works
  # - type: web
  #   name: dycetix-customer
  #   ...
  # Customer Application - Add auto-migrations too
  - type: web
    name: dycetix-customer
    env: python
    region: oregon
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      cd customer && python manage.py collectstatic --noinput
    startCommand: |
      cd customer && 
      python manage.py migrate --noinput &&
      gunicorn dycetix_project.wsgi:application --workers=2 --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dycetix-db
          property: connectionString
      - key: CUSTOMER_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: 'false'
      - key: RENDER
        value: 'true'
      - key: PYTHON_VERSION
        value: 3.11.0